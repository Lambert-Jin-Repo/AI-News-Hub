name: Scheduled Jobs

on:
  schedule:
    # Fetch news every 12 hours at 6 AM / 6 PM AWST (UTC: 22:00, 10:00)
    - cron: "0 22,10 * * *"
    # Summarise 30 min after each fetch (UTC: 22:30, 10:30)
    - cron: "30 22,10 * * *"
    # Generate daily digest at 23:00 UTC (07:00 AWST)
    - cron: "0 23 * * *"
  workflow_dispatch:
    inputs:
      job:
        description: "Job to run"
        required: true
        type: choice
        options:
          - fetch-news
          - summarise
          - daily-digest

jobs:
  fetch-news:
    if: >
      github.event_name == 'workflow_dispatch' && github.event.inputs.job == 'fetch-news' ||
      github.event_name == 'schedule' && github.event.schedule == '0 22,10 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger fetch-news
        run: |
          curl -s -X POST \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.CLOUD_RUN_URL }}/api/jobs/fetch-news"

  summarise:
    if: >
      github.event_name == 'workflow_dispatch' && github.event.inputs.job == 'summarise' ||
      github.event_name == 'schedule' && github.event.schedule == '30 22,10 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger summarise
        run: |
          curl -s -X POST \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.CLOUD_RUN_URL }}/api/jobs/summarise"

  daily-digest:
    if: >
      github.event_name == 'workflow_dispatch' && github.event.inputs.job == 'daily-digest' ||
      github.event_name == 'schedule' && github.event.schedule == '0 23 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger daily-digest
        run: |
          curl -s -X POST \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.CLOUD_RUN_URL }}/api/jobs/daily-digest"
